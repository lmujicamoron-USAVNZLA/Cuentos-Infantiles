<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Story Creator Kids</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .story-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .story-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .story-thumb {
            width: 100%;
            height: 180px;
            background: #eee;
            border-radius: 1rem;
            margin-bottom: 1rem;
            object-fit: cover;
        }

        .create-btn-large {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius);
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            border: none;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .create-btn-large:hover {
            transform: scale(1.02);
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .create-btn-large {
                padding: 1.5rem;
                font-size: 1.2rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            backdrop-filter: blur(8px);
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .story-thumb {
            width: 100%;
            height: 180px;
            background: #eee;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            object-fit: cover;
        }

        .action-btn {
            position: absolute;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .action-btn:hover {
            transform: scale(1.15);
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .action-btn.delete {
            top: 0.75rem;
            right: 0.75rem;
            color: #ef4444;
        }

        .action-btn.export {
            top: 0.75rem;
            right: 3.5rem;
            color: var(--primary);
        }

        .action-btn.edit {
            top: 0.75rem;
            right: 6.25rem;
            color: #f59e0b;
        }

        .action-btn.image {
            top: 0.75rem;
            right: 9rem;
            color: #10b981;
        }

        .action-btn.delete:hover,
        .action-btn.export:hover,
        .action-btn.edit:hover,
        .action-btn.image:hover {
            color: white;
        }

        .story-thumb {
            width: 100%;
            height: 180px;
            background: #eee;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            object-fit: cover;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: flex-start;
            /* Evita que se corten los botones */
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
            padding: 5vh 0;
            /* Padding relativo para mayor margen */
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-cancel {
            background: #cbd5e1;
            /* Gris m√°s oscuro y visible */
            color: #1e293b;
        }

        .modal-btn-cancel:hover {
            background: #94a3b8;
        }

        .modal-btn-delete {
            background: #ef4444;
            color: white;
        }

        .modal-btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
        }

        /* Estilos para el Modal de Edici√≥n */
        #editStoryText {
            width: 100%;
            height: 200px;
            padding: 1rem;
            border-radius: 1rem;
            border: 2px solid #eef2ff;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            margin-top: 1rem;
            outline: none;
        }

        #editStoryText:focus {
            border-color: var(--primary);
        }

        /* Estilos de la Galer√≠a M√°gica Corregidos */
        .image-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            /* M√°s flexible */
            gap: 1rem;
            margin-top: 1.5rem;
            max-height: 450px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid #eee;
            border-radius: 1rem;
        }

        .gallery-item {
            width: 100%;
            height: 120px;
            /* Altura fija para evitar solapamientos */
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            overflow: hidden;
            position: relative;
            background: #f1f5f9;
            /* Fondo de carga */
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            /* Evitar espacios extra */
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item.selected {
            border: 5px solid var(--primary) !important;
            box-shadow: 0 0 30px rgba(99, 102, 241, 1) !important;
            transform: scale(1.05) translateY(-5px);
            z-index: 5;
        }

        /* Indicador de carga para galer√≠a */
        #galleryLoader {
            grid-column: 1/-1;
            text-align: center;
            padding: 3rem;
            display: none;
        }

        .magic-spinner {
            font-size: 3rem;
            animation: rotate 2s linear infinite;
            display: inline-block;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .gallery-item.selected::after {
            content: "‚ú®";
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.8rem;
            color: white;
        }
    </style>
</head>

<body>
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <!-- Modal de Confirmaci√≥n Eliminaci√≥n -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content">
            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üóëÔ∏è ¬øEliminar cuento?</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">Esta acci√≥n no se puede deshacer. El cuento
                desaparecer√° de tu biblioteca para siempre.</p>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">‚¨ÖÔ∏è Volver</button>
                <button class="modal-btn modal-btn-delete" onclick="executeDelete()">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">‚úçÔ∏è Editar Cuento</h3>
            <div class="input-group" style="margin-bottom: 0.5rem;">
                <label for="editStoryTitle">T√≠tulo</label>
                <input type="text" id="editStoryTitle"
                    style="width: 100%; padding: 0.8rem; border-radius: 0.8rem; border: 1px solid #ddd;">
            </div>
            <textarea id="editStoryText" placeholder="Escribe aqu√≠ tu cuento m√°gico..."></textarea>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">‚¨ÖÔ∏è Volver</button>
                <button class="modal-btn modal-btn-primary" onclick="saveEditedStory()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Imagen -->
    <div class="modal-overlay" id="imageModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">üé® Galer√≠a M√°gica Rebosante</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Selecciona una nueva ilustraci√≥n. ¬°Hay m√°s de 20
                opciones!</p>

            <div
                style="margin-top: 1rem; display: flex; gap: 0.75rem; background: #f8fafc; padding: 0.5rem; border-radius: 1.5rem; border: 1px solid #e2e8f0; position: relative; align-items: center;">
                <input type="text" id="gallerySearch"
                    placeholder="Busca lo que imagines (ej. superman, robot, playa)..."
                    onkeyup="if(event.key === 'Enter') filterGallery()" oninput="liveGallerySearch()"
                    style="flex: 1; border: none; background: transparent; padding: 0.5rem 1rem; outline: none; font-size: 1rem;">
                <button id="clearGallerySearch" onclick="clearGallerySearch()"
                    style="background: #cbd5e1; border: none; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; cursor: pointer; color: #1e293b; font-size: 0.8rem; margin-right: 0.5rem;">‚úï</button>
                <button onclick="filterGallery()"
                    style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border: none; border-radius: 1.2rem; padding: 0.6rem 1.5rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">‚ú®
                    Magia</button>
            </div>

            <div class="image-gallery-grid" id="galleryGrid" style="margin-top: 1.5rem; min-height: 200px;">
                <!-- Se cargar√° mediante JS -->
            </div>
            <div id="galleryLoader">
                <div class="magic-spinner">ü™Ñ</div>
                <p style="color: var(--primary); font-weight: 600; margin-top: 1rem;">Buscando en el cofre m√°gico...</p>
            </div>

            <div class="modal-actions" style="margin-top: 2rem; flex-direction: row-reverse; gap: 1rem;">
                <button class="modal-btn modal-btn-primary" id="confirmImageBtn"
                    style="opacity: 0.5; cursor: not-allowed; flex: 2; font-size: 1.1rem; padding: 1rem;"
                    onclick="saveNewImage()" disabled>‚ú® ¬°Usar esta Imagen!</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeImageModal()" style="flex: 1;">‚¨ÖÔ∏è
                    Volver</button>
            </div>
        </div>
    </div>

    <main class="container" style="max-width: 1000px;">
        <nav class="nav-bar">
            <h2 style="font-weight: 600; color: var(--primary);">Story Creator Kids</h2>
            <div class="user-profile">
                <span id="displayUserName">Cargando...</span>
                <img id="userAvatar" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix" alt="User"
                    onclick="firebase.auth().signOut()" style="cursor: pointer;" title="Cerrar sesi√≥n">
            </div>
        </nav>

        <button class="create-btn-large" onclick="window.location.href='create-story.html'">
            ‚ú® Crear nueva historia m√°gica
        </button>

        <div class="dashboard-grid" id="storiesGrid">
            <!-- Los cuentos se cargar√°n din√°micamente aqu√≠ -->
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- jsPDF para exportaci√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA7vi4r6ahe-sZf8bFW0u1zCB54JkHPDFw",
            authDomain: "cuentos-infantiles-2026.firebaseapp.com",
            projectId: "cuentos-infantiles-2026",
            storageBucket: "cuentos-infantiles-2026.firebasestorage.app",
            messagingSenderId: "454293856709",
            appId: "1:454293856709:web:6b40a7fa1788e3681c6bac",
            measurementId: "G-GSLT5XHTPV"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ELEMENTOS UI
        const displayNameEl = document.getElementById('displayUserName');
        const userAvatarEl = document.getElementById('userAvatar');
        const libraryGrid = document.getElementById('storiesGrid'); // Renamed from storiesGrid to libraryGrid for consistency with the snippet, but kept the ID.

        // LOGOUT
        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            });
        }

        // CONTROL DE SESI√ìN
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // 1. Obtener Nombre para mostrar
                const name = user.displayName || user.email.split('@')[0];
                displayNameEl.innerText = `Hola, ${name}`; // Added "Hola, " back for a friendly greeting.

                // 2. Avatar M√°gico Inteligente
                if (user.photoURL) {
                    userAvatarEl.src = user.photoURL;
                } else {
                    // Detecci√≥n "M√°gica" de G√©nero por terminaci√≥n (Simple pero efectiva para ni√±os)
                    const firstName = name.split(' ')[0].toLowerCase();
                    const isGirl = firstName.endsWith('a') || firstName === 'belen' || firstName === 'carmen';

                    // Configuraci√≥n DiceBear
                    const seed = encodeURIComponent(name);

                    let avatarOptions = "radius=50";
                    if (isGirl) {
                        // Ni√±a: Pelo largo verificado
                        avatarOptions += "&backgroundColor=fbc3bc&top=bigHair";
                    } else {
                        // Ni√±o: Pelo corto verificado
                        avatarOptions += "&backgroundColor=a2d2ff&top=shortFlat";
                    }

                    userAvatarEl.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&${avatarOptions}`;
                }

                loadStories(user.uid);
            } else {
                window.location.href = 'login.html'; // Kept original 'login.html' as the snippet's 'index.html' might be a typo or specific to a different flow.
            }
        });

        async function loadStories(userId) {
            const grid = document.getElementById('storiesGrid');
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 2rem;">Abriendo tu biblioteca de cuentos...</p>';

            try {
                const snapshot = await db.collection("stories")
                    .where("userId", "==", userId)
                    .orderBy("createdAt", "desc")
                    .get();

                renderStories(snapshot, grid);

            } catch (error) {
                console.error("Error cargando cuentos:", error);

                // Intento de recuperaci√≥n: Consulta simple sin ordenamiento (por si falta el √≠ndice)
                if (error.code === 'failed-precondition' || error.message.includes('index')) {
                    try {
                        console.log("Intentando carga sin ordenamiento...");
                        const snapshot = await db.collection("stories")
                            .where("userId", "==", userId)
                            .get();

                        renderStories(snapshot, grid);

                        // Avisar discretamente
                        const warning = document.createElement('div');
                        warning.style = "grid-column: 1/-1; text-align: center; color: #f59e0b; font-size: 0.8rem; margin-top: 1rem;";
                        warning.innerText = "Nota: Los cuentos pueden no estar ordenados por fecha (Falta √≠ndice en Firebase).";
                        grid.appendChild(warning);
                        return;
                    } catch (retryError) {
                        console.error("Fallo tambi√©n el reintento:", retryError);
                    }
                }

                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <p style="color: #ef4444; font-weight: bold;">Error al cargar la biblioteca m√°gina.</p>
                    <p style="color: #666; font-size: 0.9rem;">Los duendes dicen: "${error.message}"</p>
                </div>`;
            }
        }

        function renderStories(snapshot, grid) {
            grid.innerHTML = '';

            if (snapshot.empty) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                        <img src="https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&q=80&w=300" 
                                style="width: 120px; border-radius: 1rem; margin-bottom: 1rem; opacity: 0.7;">
                        <p style="color: var(--text-muted);">Tu biblioteca est√° vac√≠a. ¬°Crea tu primer cuento m√°gico!</p>
                    </div>
                `;
                return;
            }

            snapshot.forEach(doc => {
                const story = doc.data();
                const card = document.createElement('div');
                card.className = 'story-card';
                card.onclick = () => {
                    localStorage.setItem('currentStoryId', doc.id);
                    window.location.href = 'story-reader.html';
                };

                // Prioridad total para la identidad del cuento: 1. Portada, 2. Protagonista, 3. Lugar, 4. Backup
                let imgUrl = story.coverImg || story.characterImg || story.placeImg || 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&q=80&w=400';

                card.innerHTML = `
                    <button class="action-btn delete" onclick="event.stopPropagation(); confirmDelete('${doc.id}', '${story.title.replace(/'/g, "\\'")}')" title="Eliminar">üóëÔ∏è</button>
                    <button class="action-btn export" onclick="event.stopPropagation(); exportToPDF('${doc.id}')" title="Descargar PDF">üì•</button>
                    <button class="action-btn edit" onclick="event.stopPropagation(); openEditModal('${doc.id}')" title="Editar">‚úçÔ∏è</button>
                    <button class="action-btn image" onclick="event.stopPropagation(); openImageModal('${doc.id}')" title="Imagen">üé®</button>
                    <img src="${imgUrl}" class="story-thumb" alt="Story" onerror="this.src='https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&q=80&w=400'">
                    <div style="padding: 0.2rem;">
                        <h3 style="margin-bottom: 0.25rem; font-size: 1.1rem; color: var(--text-main);">${story.title}</h3>
                        <p style="color: var(--text-muted); font-size: 0.8rem;">${story.character} en ${story.place}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- FUNCIONES DE ELIMINACI√ìN ---
        let storyToDelete = null;

        function confirmDelete(storyId, storyTitle) {
            storyToDelete = storyId;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            storyToDelete = null;
        }

        async function executeDelete() {
            if (!storyToDelete) return;

            const deleteBtn = document.querySelector('.modal-btn-delete');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '‚è≥ Eliminando...';
            deleteBtn.disabled = true;

            try {
                await db.collection('stories').doc(storyToDelete).delete();
                closeDeleteModal();
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
                // Recargar la biblioteca con el usuario actual
                const user = firebase.auth().currentUser;
                if (user) loadStories(user.uid);
            } catch (error) {
                console.error('Error al eliminar:', error);
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;

                let errorMsg = '‚ùå Error al eliminar el cuento.';
                if (error.code === 'permission-denied') {
                    errorMsg += ' No tienes permisos para eliminar este cuento.';
                } else if (error.code === 'unavailable') {
                    errorMsg += ' Verifica tu conexi√≥n a internet.';
                } else {
                    errorMsg += ` (${error.message})`;
                }

                alert(errorMsg);
            }
        }

        // --- EXPORTAR A PDF ---
        async function exportToPDF(storyId) {
            try {
                const docSnap = await db.collection('stories').doc(storyId).get();
                if (!docSnap.exists) return;
                const story = docSnap.data();

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const margin = 20;
                const pageWidth = pdf.internal.pageSize.getWidth();

                // T√≠tulo
                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(22);
                pdf.setTextColor(79, 70, 229); // Color Primary
                pdf.text(story.title, margin, 30);

                // Info
                pdf.setFontSize(12);
                pdf.setFont("helvetica", "italic");
                pdf.setTextColor(100, 116, 139);
                pdf.text(`Una aventura de ${story.character} en ${story.place}`, margin, 40);

                // L√≠nea divisoria
                pdf.setDrawColor(226, 232, 240);
                pdf.line(margin, 45, pageWidth - margin, 45);

                // Contenido
                pdf.setFont("helvetica", "normal");
                pdf.setTextColor(51, 65, 85);
                pdf.setFontSize(14);

                const splitText = pdf.splitTextToSize(story.content, pageWidth - (margin * 2));
                pdf.text(splitText, margin, 60);

                // Pie de p√°gina
                pdf.setFontSize(10);
                pdf.setTextColor(148, 163, 184);
                pdf.text("Creado con Story Creator Kids ‚ú®", margin, pdf.internal.pageSize.getHeight() - 10);

                pdf.save(`${story.title.replace(/\s+/g, '_')}_Cuento.pdf`);

            } catch (error) {
                console.error("Error exportando PDF:", error);
                alert("Hubo un error al generar el PDF m√°gino.");
            }
        }

        // --- FUNCIONES DE EDICI√ìN ---
        let storyToEdit = null;

        async function openEditModal(storyId) {
            storyToEdit = storyId;
            try {
                const docSnap = await db.collection('stories').doc(storyId).get();
                if (!docSnap.exists) return;
                const data = docSnap.data();

                document.getElementById('editStoryTitle').value = data.title;
                document.getElementById('editStoryText').value = data.content;
                document.getElementById('editModal').classList.add('active');
            } catch (error) {
                console.error("Error abriendo editor:", error);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            storyToEdit = null;
        }

        async function saveEditedStory() {
            if (!storyToEdit) return;

            const newTitle = document.getElementById('editStoryTitle').value.trim();
            const newContent = document.getElementById('editStoryText').value.trim();

            if (!newTitle || !newContent) {
                alert("El t√≠tulo y el contenido no pueden estar vac√≠os.");
                return;
            }

            try {
                await db.collection('stories').doc(storyToEdit).update({
                    title: newTitle,
                    content: newContent
                });
                closeEditModal();
                const user = firebase.auth().currentUser;
                if (user) loadStories(user.uid);
            } catch (error) {
                console.error("Error guardando edici√≥n:", error);
                alert("Hubo un error al guardar los cambios.");
            }
        }

        // --- FUNCIONES DE CAMBIO DE IMAGEN CON GALER√çA ---
        let storyToUpdateImage = null;
        let selectedImageUrl = null;

        const magicImages = [
            // Aventura
            { url: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&q=80&w=400", tags: "aventura libro lectura bosque cuentos magia historia pajaro hoja papel leer escrito autor literatura" },
            { url: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&q=80&w=400", tags: "aventura castillo magia palacio fortaleza rey reina princesa principe caballero dragon torre medieval" },
            { url: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=400", tags: "aventura monta√±a naturaleza aire libre pico nieve azul frio altura viaje excursion" },
            { url: "https://images.unsplash.com/photo-1534447677768-be436bb09401?auto=format&fit=crop&q=80&w=400", tags: "aventura selva jungla explorador verde plantas lianas safari bosque tropical amazonas" },
            // Animales
            { url: "https://images.unsplash.com/photo-1550747528-cdb45925b3f7?auto=format&fit=crop&q=80&w=400", tags: "animal unicornio blanco fantasia caballo cuerno magico brillo arcoiris mitologico" },
            { url: "https://images.unsplash.com/photo-1546776310-eef45dd6d63c?auto=format&fit=crop&q=80&w=400", tags: "animal robot perro tecnologia cibernetico metal futuro juguete raro maquina androide" },
            { url: "https://images.unsplash.com/photo-1583337130417-3346a1be7dee?auto=format&fit=crop&q=80&w=400", tags: "animal perro cachorro mascota can tierno peludo oido orejas fiel amigo guau" },
            { url: "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?auto=format&fit=crop&q=80&w=400", tags: "animal gato minino mascota felino orejas bigotes gatito miau ronroneo casa" },
            // Fantas√≠a
            { url: "https://images.unsplash.com/photo-1516331138075-f3ad16d49f25?auto=format&fit=crop&q=80&w=400", tags: "fantasia estrellas brillante noche cielo luz polvo hadas centelleo universo" },
            { url: "https://images.unsplash.com/photo-1519074063912-211c5f66be0f?auto=format&fit=crop&q=80&w=400", tags: "fantasia hada bosque magia peque volando alas criatura bosque encantado" },
            { url: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?auto=format&fit=crop&q=80&w=400", tags: "fantasia cristal castillo brillante diamante joya luz palacio reluciente" },
            { url: "https://images.unsplash.com/photo-1493612276216-ee3925520721?auto=format&fit=crop&q=80&w=400", tags: "fantasia mundo magico surrealista sue√±o arte colores imaginacion viaje" },
            // Espacio
            { url: "https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&q=80&w=400", tags: "espacio tierra planeta nasa astronauta naves estrellas galaxia orbita mundo cohete" },
            { url: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&q=80&w=400", tags: "espacio galaxia azul cosmos estrellas infinito universo red sistema solar" },
            { url: "https://images.unsplash.com/photo-1447433589675-4aaa56a4010a?auto=format&fit=crop&q=80&w=400", tags: "espacio estrellas nebulosa polvo gas colores vacio profundo" },
            { url: "https://images.unsplash.com/photo-1614730321146-b6fa6a46bac4?auto=format&fit=crop&q=80&w=400", tags: "espacio luna noche crater astronauta bandera satelite blanco negro" },
            // Naturaleza / Paisajes
            { url: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&q=80&w=400", tags: "paisaje bosque verde arboles bosque madera sol rayos luz pinos paz" },
            { url: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&q=80&w=400", tags: "paisaje rio agua monta√±as lago canoa paz reflejo naturaleza" },
            { url: "https://images.unsplash.com/photo-1470770841072-f978cf4d019e?auto=format&fit=crop&q=80&w=400", tags: "paisaje casa campo flores granja jardin verde cielo granero pradera" },
            { url: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&q=80&w=400", tags: "paisaje playa mar arena oceano palmeras vacaciones sol azul verano olas" }
        ];

        // Biblioteca curada - Iconos de alta calidad
        const curatedImages = {
            // Personajes Ic√≥nicos - Usamos DiceBear (Garant√≠a de carga 100% y estilo consistente)
            'superman': 'https://api.dicebear.com/7.x/adventurer/svg?seed=superman-hero&backgroundColor=dc2626&scale=90',
            'batman': 'https://api.dicebear.com/7.x/adventurer/svg?seed=batman-dark&backgroundColor=1e293b&scale=90',
            'spiderman': 'https://api.dicebear.com/7.x/adventurer/svg?seed=spiderman-web&backgroundColor=dc2626&scale=90',
            'kaliman': 'https://api.dicebear.com/7.x/adventurer/svg?seed=kaliman-turban&backgroundColor=0ea5e9&scale=90',
            'kalim√°n': 'https://api.dicebear.com/7.x/adventurer/svg?seed=kaliman-turban&backgroundColor=0ea5e9&scale=90',
            'wonder woman': 'https://api.dicebear.com/7.x/adventurer/svg?seed=wonder-woman&backgroundColor=ec4899&scale=90',
            'mujer maravilla': 'https://api.dicebear.com/7.x/adventurer/svg?seed=wonder-woman&backgroundColor=ec4899&scale=90',
            'flash': 'https://api.dicebear.com/7.x/adventurer/svg?seed=flash-speed&backgroundColor=f59e0b&scale=90',
            'perro': 'https://api.dicebear.com/7.x/adventurer/svg?seed=happy-dog&backgroundColor=fbbf24&scale=90',
            'gato': 'https://api.dicebear.com/7.x/adventurer/svg?seed=cute-cat&backgroundColor=f97316&scale=90',
            'gallo': 'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?auto=format&fit=crop&q=80&w=400',
            'robot': 'https://api.dicebear.com/7.x/bottts/svg?seed=robot-tech&backgroundColor=94a3b8&scale=90',
            'disney': 'https://images.unsplash.com/photo-1510253406240-620023485747?auto=format&fit=crop&q=80&w=400',
            'disneylandia': 'https://images.unsplash.com/photo-1510253406240-620023485747?auto=format&fit=crop&q=80&w=400'
        };

        // Biblioteca secundaria para fallbacks
        const characterLibrary = {
            'superman': 'https://images.unsplash.com/photo-1531259683007-016a7b628fc3?auto=format&fit=crop&q=80&w=400',
            'batman': 'https://images.unsplash.com/photo-1531259683007-016a7b628fc3?auto=format&fit=crop&q=80&w=400',
            'kaliman': 'https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?auto=format&fit=crop&q=80&w=400',
            'h√©roe': 'https://images.unsplash.com/photo-1531259683007-016a7b628fc3?auto=format&fit=crop&q=80&w=400',
            'disneylandia': 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?auto=format&fit=crop&q=80&w=400',
            'disney landia': 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?auto=format&fit=crop&q=80&w=400'
        };

        function openImageModal(storyId) {
            storyToUpdateImage = storyId;
            selectedImageUrl = null;
            document.getElementById('gallerySearch').value = '';

            renderGallery(magicImages);

            const confirmBtn = document.getElementById('confirmImageBtn');
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.cursor = 'not-allowed';
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = 'Usar Imagen ‚ú®'; // Reset text

            document.getElementById('imageModal').classList.add('active');
            setTimeout(() => document.getElementById('gallerySearch').focus(), 100);
        }

        // DICCIONARIO MAESTRO: Unificaci√≥n total de t√©rminos y categor√≠as
        const masterDictionary = {
            // CATEGOR√çA: SUJETOS (Personajes, Animales) -> Fallback: DiceBear
            'perro': { en: 'dog', cat: 'subject' },
            'gato': { en: 'cat', cat: 'subject' },
            'leon': { en: 'lion', cat: 'subject' },
            'le√≥n': { en: 'lion', cat: 'subject' },
            'tigre': { en: 'tiger', cat: 'subject' },
            'elefante': { en: 'elephant', cat: 'subject' },
            'conejo': { en: 'rabbit', cat: 'subject' },
            'pajaro': { en: 'bird', cat: 'subject' },
            'p√°jaro': { en: 'bird', cat: 'subject' },
            'oso': { en: 'bear', cat: 'subject' },
            'mono': { en: 'monkey', cat: 'subject' },
            'jirafa': { en: 'giraffe', cat: 'subject' },
            'vaca': { en: 'cow', cat: 'subject' },
            'cerdo': { en: 'pig', cat: 'subject' },
            'caballo': { en: 'horse', cat: 'subject' },
            'raton': { en: 'mouse', cat: 'subject' },
            'rat√≥n': { en: 'mouse', cat: 'subject' },
            'dinosaurio': { en: 'dinosaur', cat: 'subject' },
            'dragon': { en: 'dragon', cat: 'subject' },
            'drag√≥n': { en: 'dragon', cat: 'subject' },
            'sapo': { en: 'frog', cat: 'subject' },
            'rana': { en: 'frog', cat: 'subject' },
            'sapito': { en: 'cute frog', cat: 'subject' },
            'superman': { en: 'classic superhero with red cape and blue suit flying, comic book style', cat: 'subject' },
            'batman': { en: 'superhero batman in black suit with cape, dark comic style', cat: 'subject' },
            'spiderman': { en: 'superhero spiderman in red and blue suit, comic book style', cat: 'subject' },
            'robot': { en: 'friendly cute robot', cat: 'subject' },
            'princesa': { en: 'princess', cat: 'subject' },
            'principe': { en: 'prince', cat: 'subject' },
            'pr√≠ncipe': { en: 'prince', cat: 'subject' },
            'hada': { en: 'fairy', cat: 'subject' },
            'mago': { en: 'wizard', cat: 'subject' },
            'pirata': { en: 'pirate', cat: 'subject' },
            'ninja': { en: 'ninja', cat: 'subject' },
            'caballero': { en: 'knight', cat: 'subject' },
            'astronauta': { en: 'astronaut', cat: 'subject' },
            'capit√°n am√©rica': { en: 'superhero Captain America with blue suit and star shield, comic style', cat: 'subject' },
            'kaliman': { en: 'muscular hero with white turban, blue cape, and blue eyes, comic book style', cat: 'subject' },
            'marciano': { en: 'alien martian', cat: 'subject' },
            'alien': { en: 'alien character', cat: 'subject' },
            'extraterrestre': { en: 'alien creature', cat: 'subject' },
            'bombero': { en: 'firefighter', cat: 'subject' },
            'policia': { en: 'police officer', cat: 'subject' },
            'polic√≠a': { en: 'police officer', cat: 'subject' },
            // CATEGOR√çA: PAISAJES / OBJETOS -> Fallback: LoremFlickr
            'bosque': { en: 'enchanted forest', cat: 'landscape' },
            'playa': { en: 'tropical beach', cat: 'landscape' },
            'mar': { en: 'deep blue sea', cat: 'landscape' },
            'espacio': { en: 'outer space stars', cat: 'landscape' },
            'zoologico': { en: 'zoo animals', cat: 'landscape' },
            'zoo': { en: 'zoo background', cat: 'landscape' },
            'hospital': { en: 'medical hospital', cat: 'landscape' },
            'escuela': { en: 'school building', cat: 'landscape' },
            'colegio': { en: 'school building', cat: 'landscape' },
            'rusia': { en: 'russia red square', cat: 'landscape' },
            'china': { en: 'great wall china', cat: 'landscape' },
            'mexico': { en: 'mexico landscape', cat: 'landscape' },
            'm√©xico': { en: 'mexico landscape', cat: 'landscape' },
            'parque de diversiones': { en: 'amusement park', cat: 'landscape' },
            'parque de atracciones': { en: 'amusement park', cat: 'landscape' },
            'parque': { en: 'beautiful park', cat: 'landscape' },
            'feria': { en: 'carnival fair', cat: 'landscape' },
            'selva': { en: 'tropical jungle', cat: 'landscape' },
            'castillo': { en: 'magic castle', cat: 'landscape' },
            'ciudad': { en: 'colorful city', cat: 'landscape' },
            'nieve': { en: 'snowy landscape', cat: 'landscape' },
            'volcan': { en: 'erupting volcano', cat: 'landscape' },
            'volc√°n': { en: 'erupting volcano', cat: 'landscape' },
            'cohete': { en: 'rocket ship', cat: 'landscape' },
            'isla': { en: 'tropical island', cat: 'landscape' },
            'desierto': { en: 'sand desert', cat: 'landscape' },
            'monta√±a': { en: 'high mountain landscape', cat: 'landscape' },
            'rio': { en: 'running river', cat: 'landscape' },
            'r√≠o': { en: 'running river', cat: 'landscape' },
            'r√≠o': { en: 'running river', cat: 'landscape' },
            'lago': { en: 'peaceful lake', cat: 'landscape' },
            'disneylandia': { en: 'magical theme park castle, disney style', cat: 'landscape' },
            'disney landia': { en: 'magical theme park castle, disney style', cat: 'landscape' },
            'disney': { en: 'magical amusement park', cat: 'landscape' },
            'new york': { en: 'new york city skyline', cat: 'landscape' },
            'paris': { en: 'paris eiffel tower', cat: 'landscape' },
            'par√≠s': { en: 'paris eiffel tower', cat: 'landscape' },
            'londres': { en: 'london city big ben', cat: 'landscape' },
            'roma': { en: 'rome colosseum', cat: 'landscape' },
            'egipto': { en: 'egypt pyramids', cat: 'landscape' },
            'jap√≥n': { en: 'japan mount fuji', cat: 'landscape' },
            'auto': { en: 'modern colorful car', cat: 'landscape' },
            'carro': { en: 'modern colorful car', cat: 'landscape' },
            'avion': { en: 'airplane flying', cat: 'landscape' },
            'avi√≥n': { en: 'airplane flying', cat: 'landscape' },
            'barco': { en: 'sailing boat', cat: 'landscape' },
            'bicicleta': { en: 'colorful bicycle', cat: 'landscape' },
            'tren': { en: 'toy train', cat: 'landscape' },
            'camion': { en: 'big truck', cat: 'landscape' },
            'cami√≥n': { en: 'big truck', cat: 'landscape' },
            'gallo': { en: 'colorful rooster', cat: 'subject' }
        };

        function renderGallery(images) {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';

            if (images.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #94a3b8;">No encontramos esa magia... ¬°Intenta otra palabra!</p>';
                return;
            }

            images.forEach(img => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.innerHTML = `<img src="${img.url}" alt="Opci√≥n M√°gica" loading="lazy">`;
                item.onclick = () => selectImage(img.url, item);

                const imgElement = item.querySelector('img');
                imgElement.onerror = () => {
                    const query = img.tags || 'magic';
                    const cleanQuery = query.toLowerCase().replace(/^(en |de |un |una |la |el |al )+/, '').trim();

                    // Prioridad de Fallback: 1. Curated -> 2. AI Dictionary -> 3. Generic
                    if (curatedImages[cleanQuery]) {
                        imgElement.src = curatedImages[cleanQuery];
                    } else if (characterLibrary[cleanQuery]) {
                        imgElement.src = characterLibrary[cleanQuery];
                    } else {
                        const entry = Object.entries(masterDictionary).find(([k]) => new RegExp(`\\b${k}\\b`, 'i').test(cleanQuery));
                        const category = entry ? entry[1].cat : 'landscape';

                        if (category === 'landscape') {
                            const tags = cleanQuery.replace(/\s+/g, ',');
                            imgElement.src = `https://loremflickr.com/512/512/${encodeURIComponent(tags)}?lock=${Math.floor(Math.random() * 999999)}`;
                        } else {
                            // DIVERSIFICACI√ìN REAL: Usamos un seed √∫nico para CADA imagen
                            const uniqueSeed = encodeURIComponent(cleanQuery) + '_' + Math.floor(Math.random() * 999999) + '_' + Date.now();
                            imgElement.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${uniqueSeed}&backgroundColor=ffd5dc`;
                        }
                    }
                };
                grid.appendChild(item);
            });
        }

        let galleryDebounceTimer;
        function liveGallerySearch() {
            clearTimeout(galleryDebounceTimer);
            galleryDebounceTimer = setTimeout(() => {
                filterGallery();
            }, 800);
            toggleGalleryClearBtn();
        }

        async function filterGallery() {
            const queryInput = document.getElementById('gallerySearch');
            const query = queryInput.value.toLowerCase().trim();
            if (!query) {
                renderGallery(magicImages);
                return;
            }

            const grid = document.getElementById('galleryGrid');
            const loader = document.getElementById('galleryLoader');

            grid.innerHTML = '';
            loader.style.display = 'block';

            // 1. FILTRAR IM√ÅGENES LOCALES (magicImages)
            const localResults = magicImages.filter(img =>
                img.tags.toLowerCase().includes(query)
            );

            // 2. GENERAR RESULTADOS IA
            let cleanedQuery = query.replace(/^(en |de |un |una |la |el |al )+/, '').replace(/[`'"]/g, '').trim();
            let translated = cleanedQuery;
            let currentCategory = 'subject'; // Por defecto para animales/personas

            const sortedKeys = Object.keys(masterDictionary).sort((a, b) => b.length - a.length);
            for (let k of sortedKeys) {
                const regex = new RegExp(`\\b${k}\\b`, 'gi');
                if (regex.test(translated)) {
                    translated = translated.replace(regex, masterDictionary[k].en);
                    currentCategory = masterDictionary[k].cat;
                }
            }

            const typeKeywords = currentCategory === 'landscape'
                ? "magical colorful landscape setting, whimsical children's book style, dreamy vibrant colors, high quality"
                : "child-friendly storybook character illustration, distinctive features, cute cartoon style, colorful and vibrant, simple design, white background";

            const aiResults = [];

            // PRIORIDAD: Curada (Si aplica al query)
            if (curatedImages[cleanedQuery]) {
                aiResults.push({ url: curatedImages[cleanedQuery], tags: query });
            }

            // Generar 6-8 im√°genes IA para completar la experiencia
            for (let i = aiResults.length; i < 8; i++) {
                const seed = Math.floor(Math.random() * 999999);
                aiResults.push({
                    url: `https://image.pollinations.ai/prompt/${encodeURIComponent(translated + ' ' + typeKeywords)}?width=512&height=512&nologo=true&seed=${seed}`,
                    tags: query
                });
            }

            // Mezclar resultados locales al principio para que se note el "buscador"
            const finalResults = [...localResults, ...aiResults];

            setTimeout(() => {
                loader.style.display = 'none';
                renderGallery(finalResults);
            }, 600);
        }

        function toggleGalleryClearBtn() {
            const input = document.getElementById('gallerySearch');
            const btn = document.getElementById('clearGallerySearch');
            // Usamos trim() para que el bot√≥n no desaparezca si hay espacios
            if (input.value.trim().length > 0) btn.style.display = 'flex';
            else btn.style.display = 'none';
        }

        function clearGallerySearch() {
            const input = document.getElementById('gallerySearch');
            input.value = '';
            toggleGalleryClearBtn();
            input.focus();
            renderGallery(magicImages);
        }

        function selectImage(url, element) {
            selectedImageUrl = url;
            document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');

            const btn = document.getElementById('confirmImageBtn');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.disabled = false;
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
            storyToUpdateImage = null;
            selectedImageUrl = null;
        }

        async function saveNewImage() {
            if (!storyToUpdateImage || !selectedImageUrl) return;

            const btn = document.getElementById('confirmImageBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ü™Ñ Hechizando...';
            btn.disabled = true;

            try {
                await db.collection('stories').doc(storyToUpdateImage).update({
                    coverImg: selectedImageUrl
                });
                closeImageModal();
                const user = firebase.auth().currentUser;
                if (user) loadStories(user.uid);
            } catch (error) {
                console.error("Error actualizando imagen:", error);
                alert("Hubo un error al actualizar la imagen.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>